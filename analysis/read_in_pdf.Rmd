
Processing the OHA births PDFs

-----

```{r setup}
library(dplyr)
library(tidyr)
library(purrr)
library(stringr)
library(pdftools)
```

Alright, let's try...

```{r}
temp <- 
  pdf_data("../data/facilcesarean18.pdf") %>% 
  .[[6]]

temp %>% 
  select(-width) %>% 
  mutate(y = ifelse((y-1) %in% y, y-1, y)) %>%  # fix off-by-one alignments
  arrange(y, x)
```

```{r}
quiet_integer <- quietly(as.integer)

temp2 <- 
  temp %>% 
  select(x, y, text) %>% 
  mutate(y = ifelse((y-1) %in% y, y-1, y)) %>%  # fix off-by-one alignments
  arrange(y, x) %>% 
  filter(y > min(y[text %in% c("Vaginal", "VBAC", "Cesarean")]) + 5) %>% 
  mutate(
    text = 
      text %>% 
      str_replace("–", "0") %>% 
      str_remove("\\.+$") %>% 
      str_remove_all("(?<=\\d),(?=\\d)"),
    ints = quiet_integer(text)$result,
    line = lag(floor(cumsum(!is.na(ints))/4)) + 1,
    line = ifelse(is.na(line), 1, line)
  ) %>% 
  filter(nchar(text) > 0)

temp2
```

```{r}
min_x <- min(temp2$x)

headings <- 
  temp2 %>% 
  group_by(line) %>% 
  filter(length(unique(y)) > 1, y == min(y)) %>% 
  filter(all(x > min_x)) %>% 
  ungroup() %>% 
  group_by(y) %>% 
  summarize(text = paste(text, collapse = " "), .groups = "drop")

headings
```

```{r}
temp2 %>% 
  group_by(line) %>% 
  summarize(
    facility = paste(text[is.na(ints)], collapse = " "),
    total = ints[!is.na(ints)][1],
    vaginal = ints[!is.na(ints)][2],
    vbac = ints[!is.na(ints)][3],
    cesarean = ints[!is.na(ints)][4],
    y = last(y),
    .groups = "drop"
  ) %>% 
  mutate(
    county = map_chr(
      y,
      ~ headings %>% 
        filter(y < .x) %>% 
        pull(text) %>% 
        last()
    ),
    facility = str_remove(facility, paste0("^", county, " "))
  ) %>% 
  select(-line, -y)
```

Putting it all together...

```{r}
fmod <- 
  pdf_data("../data/facilcesarean18.pdf") %>% 
  map_dfr(function(df) {
    df2 <- 
      df %>% 
      select(x, y, text) %>% 
      mutate(y = ifelse((y-1) %in% y, y-1, y)) %>%  # fix off-by-one alignments
      arrange(y, x) %>% 
      filter(y > min(y[text %in% c("Vaginal", "VBAC", "Cesarean")]) + 5) %>% 
      mutate(
        text = 
          text %>% 
          str_replace("–", "0") %>% 
          str_remove("\\.+$") %>% 
          str_remove_all("(?<=\\d),(?=\\d)"),
        ints = quiet_integer(text)$result,
        line = lag(floor(cumsum(!is.na(ints))/4)) + 1,
        line = ifelse(is.na(line), 1, line)
      ) %>% 
      filter(nchar(text) > 0)
    
    min_x <- min(df2$x)

    headings <- 
      df2 %>% 
      group_by(line) %>% 
      filter(length(unique(y)) > 1, y == min(y)) %>% 
      filter(all(x > min_x)) %>% 
      ungroup() %>% 
      group_by(y) %>% 
      summarize(text = paste(text, collapse = " "), .groups = "drop")
    
    df2 %>% 
      group_by(line) %>% 
      summarize(
        facility = paste(text[is.na(ints)], collapse = " "),
        total = ints[!is.na(ints)][1],
        vaginal = ints[!is.na(ints)][2],
        vbac = ints[!is.na(ints)][3],
        cesarean = ints[!is.na(ints)][4],
        y = last(y),
        .groups = "drop"
      ) %>% 
      mutate(
        county = map_chr(
          y,
          ~ headings %>% 
            filter(y < .x) %>% 
            pull(text) %>% 
            last()
        ),
        facility = str_remove(facility, paste0("^", county, " "))
      ) %>% 
      select(-line, -y)
  }) %>% 
  drop_na() %>%
  mutate(across(c(total, vaginal, vbac, cesarean), as.integer))

fmod
```

```{r eval=FALSE}
saveRDS(fmod, "../output/fmod_2018.rds")
```



